<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    {% include "partials/resources.html" %}
    <link rel="icon" href="{% static 'img/logo_betech.png' %}">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPP - Home</title>
    <script>
        $(document).ready(function() {
            var input = $('input[type="file"]');
            
            input.change(function() {
                var file = input[0].files[0];
            
                if (file && file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                    $('.cargar-btn').addClass('verde');
                } else {
                    $('.cargar-btn').removeClass('verde');
                }
            });
        });
    </script>
</head>
<body>
    {% include "partials/header.html" %}
    <div class="carga">
        <label class="label-carga-masiva" for="carga-multiple">Carga Excel
            <script>
                $('.label-carga-masiva').click(function() {
                    window.location.href = "/pedido_multiple/";
                });
            </script>
        </label>
        <div class="carga-mini">
            <form method="post" enctype="multipart/form-data" class="carga-masiva">
                {% csrf_token %}
                <div class="carga-micro">
                    <input class ="label-carga-mini cargar-btn" type="submit" value="Carga datos Excel">
                    <form action="{% url 'download_file' %}" method="get">
                        <input class="label-carga-mini" type="submit" value="Descargar Formato" name="download">
                    </form>
                    <img id="icono_excel" src= "{% static 'img/icono_excel.png' %}" width="40" alt="">
                </div>
            </form>
        </div>
        <label class="label-carga-individual" for="carga-individual">Carga Individual
            <script>
                $('.label-carga-individual').click(function() {
                    window.location.href = "/pedido/";
                });
            </script>
        </label>        
    </div>

    <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ progress }}%</div>
    </div>
    <div class="gantt-container">
        <div class="gantt-here" id="gantt_here"></div>
        <script>
            var datos = {{ pedidos|safe }};
            var datos2 = {{ productos|safe }}
            // pedidos no se pueden mover
            gantt.config.drag_move = false;
            // pedido por default está bien
            // no se pueden mover flechas
            gantt.config.drag_links = false;
            // no se puede mover el progreso
            gantt.config.drag_progress = false;
            // no se puede agrandar o achicar
            gantt.config.drag_resize = false;
            // no se pueden agregar más task
            gantt.config.readonly = true;
            gantt.init("gantt_here");
            var data = [];
            var colors = ['red', 'orange', 'brown', 'green', 'blue', 'purple', 'pink'];
            for (var i = 0; i < datos.length; i++) {
                var fechaRecepcion = new Date(datos[i].fecha_recepcion);
                var fechaEntrega = new Date(datos[i].fecha_entrega);
                var duration = Math.round((fechaEntrega - fechaRecepcion)/86400000)
                fecha_recepcion = fechaRecepcion.toLocaleDateString();
                fecha_entrega = fechaEntrega.toLocaleDateString();
                var color = colors[i % colors.length];
                var item = {
                    id: i+1,
                    custom_id: datos[i].id,
                    text: "Pedido N° " + datos[i].numero_pedido,
                    start_date: fecha_recepcion,
                    duration: duration,
                    color: color
                };
            data.push(item);
            }
            gantt.parse({data: data});
            gantt.attachEvent("onTaskClick", function(id){
                // Código predefinido de onTaskClick
                // Esconde la tarea por default
                // Obtiene la tarea
                var task = gantt.getTask(id);
                // Tu lógica personalizada aquí
                if (!task.modalboxOpened) {
                    // Crear la tabla
                    var table = document.createElement('table');
                    table.classList.add('gantt_modal_table');
                    // Crear la fila de encabezado
                    var headerRow = document.createElement('tr');
                    var productHeader = document.createElement('th');
                    var quantityHeader = document.createElement('th');
                    productHeader.innerText = 'Producto';
                    quantityHeader.innerText = 'Cantidad';
                    headerRow.appendChild(productHeader);
                    headerRow.appendChild(quantityHeader);
                    table.appendChild(headerRow);

                    // Crear una fila por cada producto
                    for (var i = 0; i < datos2.length; i++) {
                        if(datos[id-1].id === datos2[i].id){
                            var row = document.createElement('tr');
                            var productCell = document.createElement('td');
                            var quantityCell = document.createElement('td');
                            productCell.innerText = datos2[i].nombre_producto;
                            quantityCell.innerText = datos2[i].volumen_producto;
                            row.appendChild(productCell);
                            row.appendChild(quantityCell);
                            table.appendChild(row);
                        }
                    }
                    var dias = task.duration === 1 ? " día" : " días";
                    var html =
                    "<p><strong>Número de Pedido:</strong> " + datos[id-1].numero_pedido +
                    "   <strong>Destino de pedido:</strong> " + datos[id-1].destino_pedido + "</p>" +
                    "<p><strong>Fecha de Recepción:</strong> " + datos[id-1].fecha_recepcion +
                    "   <strong>Fecha de Entrega:</strong> " + datos[id-1].fecha_entrega + "</p>" +
                    "<p><strong>Duración:</strong> " + task.duration + dias +
                    "<p><strong>Productos:</strong></p>" + table.outerHTML;
                    // Abrir la ventana modal con la información de la tarea
                    var box = gantt.modalbox({
                        text: html,
                        title:"Detalles del Pedido",
                        width: "80%",
                        height: "80%",
                        buttons:[{ label:"Cerrar", value:"button", css:"btn-default" }]
                    });
                    task.modalboxOpened = true;
                    var modalContent = document.querySelector('.gantt_modal_box');
                    modalContent.style.overflowY = 'scroll';
                    modalContent.style.maxHeight = 'calc(100% - 50px)'; // La altura máxima es el 
                    //Agrega un botón para cerrar la tarea
                    var cancelButton = document.querySelector(".gantt_popup_button");
                    cancelButton.addEventListener("click", function() {
                        gantt.modalbox.hide();
                        task.modalboxOpened = false;
                    });
                }
                return false;
            });
        </script>
    </div>
</body>
{% include "partials/footer.html" %}
</html>