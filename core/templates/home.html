<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    {% include "partials/resources.html" %}
    <link rel="icon" href="{% static 'img/logo_betech.png' %}">
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}">
    <link rel="stylesheet" href="{% static 'styles/styles-home.css' %}">
    <link rel="stylesheet"  href="https://fonts.googleapis.com/css?family=Roboto">
   
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPP - Home</title>

</head>
<body>
    {% include "partials/header.html" %}

    <!--Contenedor: línea de producción, Función objetivo y Período de visualización-->
    <div class="buttons-top horizontal-container">
        <div>
            <select name="lineas" id="toggle-lineas-button" class="carga-button-top">
                <option value="lineas">Lineas Producción</option>
                <option value="Delgada">Linea Delgada</option>
                <option value="Gruesa">Linea Gruesa</option>
            </select>
        </div>
        <div>
            <select name="funciones" id="toggle-lineas-button" class="carga-button-top">
                <option value="funcion">Función Objetivo</option>
                <option value="minimizar-costos">Minimizar costos</option>
                <option value="aumentar-rendimiento">Aumentar rendimiento</option>
            </select>
        </div>
        <div>
            <select name="periodos" id="toggle-lineas-button" class="carga-button-top">
                <option value="mensual">Mensual</option>
                <option value="semanal">Semanal</option>
                <option value="diario">Diario</option>
            </select>
            
        </div>
    </div>

    <div class="form-container-productos">
        <button type="button" id="toggle-carga-button" class="carga-button">Carga Manual</button>
        <form method="post" action="{% url 'pedidos' %}" style="display: none;" id="carga-form">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" name="crear">Crear</button>
        </form>
    </div>

    <br>
    <div class="table-container" style="overflow: auto; height: 75%;">

        <h1 class="text-center"> Organizador de Pedidos </h1>
        <div id="gantt" style="width: 90%; margin-left:15px; margin-right:15px">
            <script type="text/javascript">
                class Gantt {
                    constructor(tasks) {
                        this.tasks = tasks;
                        this.dateWidth = 178;
                        this.filteredTasks = tasks;
                        this.setMinAndMaxDate();
                        document.getElementById('gantt').innerHTML = this.buildTableHeader() + this.buildTableBody();
                        this.attachEventListeners();
                    }

                    setMinAndMaxDate(){
                        var maxDates = [];
                        var minDates = [];

                        for(let i = 0; i < this.tasks.length; i++){
                            minDates.push(new Date(this.tasks[i][1]));
                            maxDates.push(new Date(this.tasks[i][2]));
                        }
                        this.minDate = new Date(Math.min.apply(null,minDates));
                        this.maxDate = new Date(Math.max.apply(null,maxDates));
                    }

                    diffInMonths(max, min) {
                        return (max.getFullYear() - min.getFullYear()) * 12 + max.getMonth() - min.getMonth();
                    }

                    diffInWeeks(max, min) {
                        const oneWeek = 7 * 24 * 60 * 60 * 1000;
                        const diffTime = Math.abs(max - min);
                        return Math.ceil(diffTime / oneWeek);
                    }

                    buildTableHeader() {
                        var html = '<table><thead  style="position: sticky; top: 0; background-color: white; z-index: 1;width: 500px;"><tr>';
            
                        const selectedPeriod = document.querySelector('select[name="periodos"]').value;
                        const isDiarioSelected = selectedPeriod === "diario";
                        const isSemanalSelected = selectedPeriod === "semanal";
                        const isMensualSelected = selectedPeriod === "mensual";
            
                        // Use the format of date headers based on the selected period
                        if (isDiarioSelected) {
                            var diffDays = this.diffInDays(this.maxDate, this.minDate) + 1;
                            const actual = new Date(this.minDate);
            
                            for (let i = 0; i < diffDays; i++) {
                                actual.setDate(actual.getDate() + 1);
                                html += '<th class="date-header">' + this.formatDate(actual, "diario") + '</th>';
                            }
                        } else if (isSemanalSelected) {
                            var diffWeeks = this.diffInWeeks(this.maxDate, this.minDate) + 1;
                            const actual = new Date(this.minDate);
            
                            for (let i = 0; i < diffWeeks; i++) {
                                const startOfWeek = new Date(actual);
                                const endOfWeek = new Date(actual);
                                endOfWeek.setDate(startOfWeek.getDate() + 6);
            
                                html += '<th>' + this.formatDate(startOfWeek, "semanal", endOfWeek) + '</th>';
                                actual.setDate(startOfWeek.getDate() + 7);
                            }
                        } else if (isMensualSelected) {
                            var diffMonths = this.diffInMonths(this.maxDate, this.minDate) + 1;
                            const actual = new Date(this.minDate);
            
                            for (let i = 0; i < diffMonths; i++) {
                                actual.setMonth(actual.getMonth() + 1);
                                html += '<th>' + this.formatDate(actual, "mensual") + '</th>';
                            }
                        }
            
                        html += '</tr></thead><tbody>';
                        return html;
                    }
            
                   
                    buildTableBody() {
                        var html = '';

                        for (let i = 0; i < this.filteredTasks.length; i++) {
                            var task = this.filteredTasks[i];

                            var dMin = new Date(task[1]);
                            var dMax = new Date(task[2]);

                            var days = this.diffInDays(dMax, dMin) + 1;
                            var daysBefore = this.diffInDays(this.minDate, dMin);
                            var daysAfter = this.diffInDays(dMax, this.maxDate);

                            if (this.minDate.getTime() === dMin.getTime()) daysBefore = 0;
                            if (this.maxDate.getTime() === dMax.getTime()) daysAfter = 0;

                            html += '<tr>';
                            if (daysBefore > 0) for (let j = 0; j < daysBefore; j++) html += '<td></td>';
                            html += `<td class="event-cell" colspan="${days}" style="background-color: ${task[3]};">
                                <span>${task[4]}%</span>
                                <a class="popup-link" data-pedido-id="${i}">${task[5]}</a>
                            </td>`;
                            if (daysAfter > 0) for (let j = 0; j < daysAfter; j++) html += '<td></td>';
                            html += '</tr>';
                        }

                        return html;
                    }

                    diffInDays(max, min){
                        var diffTime = Math.abs(max - min);
                        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    }

                    formatDate(date, period, endDate) {
                        if (period === "diario") {
                            const day = date.getDate();
                            const month = date.getMonth() + 1;
                            const year = date.getFullYear();
                            return `${day}/${this.getMonthName(month)}/${year}`;
                        } else if (period === "semanal") {
                            const weekStart = new Date(date);
                            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); // Get the Monday of the week
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekEnd.getDate() + 6); // Get the Sunday of the week
            
                            const startDay = weekStart.getDate();
                            const endDay = weekEnd.getDate();
                            const startMonth = weekStart.getMonth() + 1;
                            const endMonth = weekEnd.getMonth() + 1;
                            const startYear = weekStart.getFullYear();
            
                            if (startMonth === endMonth) {
                                return `${startDay} - ${endDay} ${this.getMonthName(startMonth)} ${startYear}`;
                            } else {
                                return `${startDay} ${this.getMonthName(startMonth)} - ${endDay} ${this.getMonthName(endMonth)} ${startYear}`;
                            }
                        } else if (period === "mensual") {
                            const monthStart = new Date(date);
                            monthStart.setDate(1); // Get the first day of the month
                            const monthEnd = new Date(date);
                            monthEnd.setMonth(monthEnd.getMonth() + 1, 0); // Get the last day of the month
            
                            const startDay = monthStart.getDate();
                            const endDay = monthEnd.getDate();
                            const startMonth = monthStart.getMonth() + 1;
                            const endMonth = monthEnd.getMonth() + 1;
                            const startYear = monthStart.getFullYear();
            
                            if (startMonth === endMonth) {
                                return `${this.getMonthName(startMonth)} ${startYear}`;
                            } else {
                                return `${this.getMonthName(startMonth)} al ${endDay} ${this.getMonthName(endMonth)} ${startYear}`;
                            }
                        }
                    }
            

                    getMonthName(month) {
                        return new Date(2020, month - 1, 1).toLocaleString('default', { month: 'long' });
                    }


                

                    filterTasksByLine(lineValue) {
                        if (lineValue === "lineas") {
                            this.filteredTasks = this.tasks;
                        } else {
                            this.filteredTasks = this.tasks.filter(task => task[6] === lineValue);
                        }

                        document.getElementById('gantt').innerHTML = this.buildTableHeader() + this.buildTableBody();
                        this.attachEventListeners();
                    }

                    attachEventListeners() {
                        const popupLinks = document.querySelectorAll('.popup-link');
                        popupLinks.forEach(link => {
                            link.removeEventListener('click', this.handlePopupClick); // Remove existing event listeners
                            link.addEventListener('click', this.handlePopupClick.bind(this));
                        });
                    }

                    handlePopupClick(event) {
                        event.stopPropagation(); // Evita que el evento se propague al contenedor principal
                        const pedidoId = event.target.dataset.pedidoId; // Obtenemos el ID del pedido desde el atributo data-pedido-id
                        const popup = document.createElement('div');
                        popup.className = 'popup-overlay';
                        const pedidoData = this.tasks[pedidoId];
                        popup.innerHTML = `
                            <div class="popup-content">
                                <h1> Detalle Pedido </h2>
                                <p>Codigo: ${pedidoData[0]}</p>
                                <p>Cliente: ${pedidoData[8]} </p>
                                <p>Nombre: ${pedidoData[5]}</p>
                                <p>Fecha de entrega: ${pedidoData[2]}</p>
                                <p>Producto: ${pedidoData[10]}</p>
                                <p>Cantidad: ${pedidoData[7]}</p>
                                <p>Prioridad: ${pedidoData[11]}</p>
                                <p>Linea produccion: ${pedidoData[6]}</p>
                                <p>Progreso: ${pedidoData[4]} %</p>
                                <p>Comentario: ${pedidoData[9]}</p>
                                
                                

        
                                <button class="popup-close" onclick="this.parentElement.parentElement.remove()">X</button>
                            </div>
                        `;
                        document.body.appendChild(popup);
                    }
                }

                const tasks = {{ tasks|safe }};
                const gantt = new Gantt(tasks);

                // Set the default value for the "Periodos" select box to "mensual"
                const periodosSelect = document.querySelector('select[name="periodos"]');
                periodosSelect.value = "mensual";
                periodosSelect.addEventListener('change', function() {
                    // Rebuild the Gantt chart when the select box value changes
                    gantt.setMinAndMaxDate();
                    document.getElementById('gantt').innerHTML = gantt.buildTableHeader() + gantt.buildTableBody();
                });

                // Agrega el evento de cambio para el botón de líneas de producción
                const toggleLineasButton = document.getElementById('toggle-lineas-button');
                toggleLineasButton.addEventListener('change', function() {
                    const selectedLine = this.value;
                    gantt.filterTasksByLine(selectedLine);
                });
            </script>
        </div>
    </div>

    <div class="buttons-bot">
        <button type="button" id="toggle-lineas-button" class="carga-button-bot">Exportar</button>
        <button type="button" id="toggle-funcion-button" class="carga-button-bot">Ejecutar</button>
        <button type="button" id="toggle-periodo-button" class="carga-button-bot">Plan actual</button>
    </div>

</body>
</html>
