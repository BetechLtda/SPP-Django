<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    {% include "partials/resources.html" %}
    <link rel="icon" href="{% static 'img\logo_betech.png' %}">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles\styles.css' %}">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPP - Home</title>
</head>
<body>
    {% include "partials/header.html" %}
    <div class="carga">
        <label class="label-carga-masiva" for="carga-multiple">Carga Múltiple
            <script>
                $('.label-carga-masiva').click(function() {
                    window.location.href = "/pedido_multiple/";
                });
            </script>
        </label>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label class="label-carga-masiva" for="carga-masiva">Carga Masiva
                <input class="btn-select-file" id="carga-masiva" type="file" name="carga-masiva">
            </label>
            <input type="submit" value="Cargar">
        </form>
        <form action="{% url 'download_file' %}" method="get">
            <input type="submit" value="Plantilla Excel" name="download">
        </form>
        <label class="label-carga-individual" for="carga-individual">Carga Individual
            <script>
                $('.label-carga-individual').click(function() {
                    window.location.href = "/pedido/";
                });
            </script>
        </label>        
    </div>

    <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ progress }}%</div>
    </div>
    <div class="gantt-container">
        <div class="gantt-here" id="gantt_here"></div>
        <script>
            var datos = {{ result|safe }};
            gantt.init("gantt_here")
            var data = [];
            var colors = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink'];
            for (var i = 0; i < datos.length; i++) {
                var fechaRecepcion = new Date(datos[i].fecha_recepcion);
                var fechaEntrega = new Date(datos[i].fecha_entrega);
                fecha_recepcion = fechaRecepcion.toLocaleDateString();
                fecha_entrega = fechaEntrega.toLocaleDateString();
                var color = colors[i % colors.length];
                var item = {
                    id: i+1,
                    custom_id: datos[i].id_pedido,
                    text: "Pedido #" + datos[i].id_pedido,
                    start_date: fecha_recepcion,
                    duration: datos[i].duration,
                    color: color
                };
            data.push(item);
            }
            gantt.parse({data: data});
            gantt.attachEvent("onTaskClick", function(id){
                // Código predefinido de onTaskClick
                // Esconde la tarea por default
                // Obtiene la tarea
                var task = gantt.getTask(id);
                // Tu lógica personalizada aquí
                if (!task.modalboxOpened) { 
                    var html = "<h2>Detalles del Pedido</h2>" +
                    "<p><strong>Número de Pedido:</strong> " + datos[id-1].numero_pedido + "</p>" +
                    "<p><strong>Fecha de Recepción:</strong> " + datos[id-1].fecha_recepcion + "</p>" +
                    "<p><strong>Fecha de Entrega:</strong> " + datos[id-1].fecha_entrega + "</p>" +
                    "<p><strong>Duración:</strong> " + task.duration + ' días' + "</p>" +
                    "<p><strong>Destino de pedido:</strong> " + datos[id-1].destino_pedido + "</p>" +
                    "<button id='close-modal' type='button'>Cerrar</button>";
                    // Abrir la ventana modal con la información de la tarea
                    var box = gantt.modalbox({
                        text: html,
                        width: 200
                    });
                    task.modalboxOpened = true;
                    //Agrega un botón para cerrar la tarea
                    document.getElementById("close-modal").addEventListener("click", function() {
                        gantt.modalbox.hide(box);
                        task.modalboxOpened = false;
                    });
                }
                return false;            
            });
        </script>
    </div>
</body>
</html>